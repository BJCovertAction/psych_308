---
title: "PSYCH308C - Data Analysis 04 (DA04)"
author: "Brady C. Jackson"
date: "2025/02/24"

# Write document output to HTML, Word, and PDF output types with a Table of
# contents included.
output: 
  html_document:
    toc: true
  word_document:
    toc: true
  pdf_document:
    toc: true
    latex_engine: xelatex

# This option here enables output to both HTML and PDF formats
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding,
  output_format = "all") })
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

---

## Prompt

You have been hired by a local school to figure out what predicts child aggression in their students. The literature   
suggests that family adversity can have an impact on child aggression. However, some of the staff at this school have  
been noting (anecdotally) an interesting phenomenon that they think could be impacting this relationship. Apparently,   
even when youth have a lot of family adversity, if they also have positive friendships, then they don't seem to   
act aggressively quite as much. However, this doesn't seem to be the case for students who have a lot of adversity in  
their family and don't have good peer relationships (these students tend to act out a lot).  
  
To answer this question, the school created a short pen-and-paper survey that was recently administered to students   
that measured family adversity and positive peer relationships and a short survey that was administered to teachers   
who rated each student's level of aggression.  
  
You have been tasked with assessing their data set and analyzing whether the presence of positive peer relationships  
influences the relationship between family adversity and child aggression.   
 

## Variables 

| Variable | Type | Description |
|:-----|:---|:------------------|
| `FA` | 1-20 scale | Family Adversity (PV) |
| `PPR` | 1-20 scale | Positive Peer Relationships (ModV) |
| `AGG` | 1-20 scale |  Child Aggression (OV) |


## Assignment

### Part 1

Conduct the appropriate analyses and write a results section for an APA journal. Include all necessary tables  
and figures.


---ONLY WRITE CODE BELOW THIS LINE---

## Code

### Libraries

Load all requisite libraries here.

```{r package_loading, message=FALSE, warning=FALSE}
# Load packages. Set messages and warnings to FALSE so I don't have to see the
# masking messages in the output.
library(jmv)       # for descriptive
library(ggplot2)
library(dplyr)
library(corrplot)    # For fancy covariance matrix plots
library(apaTables)   # For Word formatted tables
library(car)         # for ncvTest (Breusch Pagan)
# library(stringr)   # for sub_str operations
library(psych)
# library(Hmisc)     # for fun.dat substitution
# library(see)       # for outliers analysis 
library(magrittr)
# library(AER)
library(rlang)
library(mvnTest)
library(easystats)
library(patchwork)
library(mvtnorm)
library(broom)
library(GGally)
library(foreign)
library(ltm)
library(rockchalk)
library(haven)
library(jtools)
library(interactions)
library(effectsize)

```


### Metadata

This section of code is to setup some general variables that we'll use throughout the code (e.g. figure colors, etc)

```{r metadata}
# First we'll defines some meta-data to use in all of our plots so they're nice and clean
font_color = "#4F81BD"
grid_color_major = "#9BB7D9"
grid_color_minor = "#C8D7EA"
back_color = "gray95"
rb_colmap = colorRampPalette( c("firebrick", "grey86", "dodgerblue3") )(200)

# I'm going to try to save off my preferred ggplot theme combinations as a unqiue theme object that I can just reference
# later in the code....totally unclear if ggplot works this way....
my_gg_theme = theme_minimal() +
              theme( plot.title = element_text(size = 12, face = "italic", color = font_color),
                     axis.title.x = element_text(color = font_color),
                     axis.title.y = element_text(color = font_color),
                     axis.text.x = element_text(color = font_color),
                     axis.text.y = element_text(color = font_color),
                     legend.title = element_text(color = font_color),
                     legend.text = element_text(color = font_color),
                     panel.grid.minor = element_line(color = grid_color_minor),
                     panel.grid.major = element_line(color = grid_color_major),
                     panel.background = element_rect(fill = back_color, color = font_color)
                   )

```

### Load and View data

Description of the data implies we have a continuous PV, a continuous ModV, and a continuous OV.  
No Dummy code needed.

```{r load_raw_data}

# Load data as downloaded from Canvas
this_dat = read.csv("./308C.Data.DA4.csv")

# Rename columns to lower because why not
colnames(this_dat) <- tolower( colnames(this_dat) )

# Since we're going to be creating a regression model we need to create the interaction term.
this_dat$p_mod_f = this_dat$ppr * this_dat$fa


```

### Descriptive Statistics - Raw Data

This section will look at base descriptive statistics of the raw data to help identify data anomalies and check   
normality of predictor variables (break length - minutes)

```{r descriptive_stats_raw}

# We'll need to check both univariate normality and multi-variate normality. 
my_descr = jmv::descriptives( this_dat,
                              vars = c('fa', 'ppr', 'agg', 'p_mod_f'),
                              hist = TRUE,
                              dens = TRUE,
                              qq = TRUE,
                              sd = TRUE,
                              variance = TRUE,
                              se = TRUE,
                              skew = TRUE,
                              kurt = TRUE,
                              missing = TRUE
                            )
print(my_descr)

```

### Correlation Plots - Raw Data

Visualize the covariance matrix to understand correlation between Success and Professionalism and Competence (Model 1)
A second correlation matrix is also computed which includes Motivation (for model 2)


```{r correlation_plots_raw}
# 
# # Model 1 Correlation Tables
# cat( 
#      paste(
#            '-----------------',
#            '---- Model 1 ----',
#            '-----------------',
#            sep = '\n'
#      ) 
#    )
# 
# # Our first model will look at correlations associated with the simpler model:
# # success ~ income + graduation
# # But, since graduation is categorical, we strip it out.
# m1_subset = this_dat[ c('income', 'success') ]
# transition_cor_m1 <- stats::cor( m1_subset )
# corrplot( transition_cor_m1,
#           method="color",
#           type = "full",
#           addCoef.col = "black",
#           col = rb_colmap,
#           tl.col = font_color )
# 
# # Print correlation tables (annoying that we have to use two different correlation functions, 1 for plotting and
# # 1 for tables, but oh well)
# transition_cor_tab_m1 <- jmv::corrMatrix(m1_subset, flag = TRUE)
# print( transition_cor_tab_m1 )
# 
# 
# # Model 2 Correlation Tables
# cat( 
#      paste(
#            '-----------------',
#            '---- Model 2 ----',
#            '-----------------',
#            sep = '\n'
#      ) 
#    )
# 
# # Our second model will look at correlations associated with the additional predictor (literacy) model:
# # success ~ income + graduation + literacy
# # But, since graduation is categorical, we strip it out.
# m2_subset = this_dat[ c('income', 'success', 'illiteracy') ]
# transition_cor_m2 <- stats::cor( m2_subset )
# corrplot( transition_cor_m2,
#           method="color",
#           type = "full",
#           addCoef.col = "black",
#           col = rb_colmap,
#           tl.col = font_color )
# 
# # Print correlation tables (annoying that we have to use two different correlation functions, 1 for plotting and
# # 1 for tables, but oh well)
# transition_cor_tab_m2 <- jmv::corrMatrix(m2_subset, flag = TRUE)
# print( transition_cor_tab_m2 )

```
### Scatterplots of All Predictor Vars

Since scatterplots are not variables based, we can create a scatterplot with Transition as a function of each of the  
2x continuous predictor vars. Scatterplots are broken out here, separate from residual plots and homoscedasticity  
testing for readability.

**NOTE:** I'm not using centered data for the scatterplots as it's unintuitive but I may add them later if necessary

```{r scatterplots_raw}
# 
# # Scatterplot 1: Transition (uncentered) vs. Income
# success_scatter_tvinc <- ggplot(this_dat, aes(income, success) )
# 
# success_scatter_tvinc +
#     geom_point() +
#     geom_smooth(method = "lm", colour = "Red") +
#     ggtitle("Transition Success Relation to Student Income") +
#     labs(y = "Transition Success (1-10)", x = "Student Income ($USD)") +
#     my_gg_theme
# 
# 
# # Scatterplot 2: Transition (uncentered) vs. Illiteracy
# success_scatter_tvil <- ggplot(this_dat, aes(illiteracy, success) )
# 
# success_scatter_tvil +
#     geom_point() +
#     geom_smooth(method = "lm", colour = "Red") +
#     ggtitle("Transition Success Relation to Student Illiteracy") +
#     labs(y = "Transition Success (1-10)", x = "Student Illiteracy (0-3)") +
#     my_gg_theme
```

### Simple Linear Model Defintion

We need to create two simple linear models for various data visualization and analysis efforts. The following code   
creates these two models:

Model 1: transition ~ graduation + income  
Model 2: transition ~ graduation + income + illiteracy  

```{r simple_model_definition}
# # We create the linear models using separate datasets simply for clarity of code and readability
# 
# # Graduation referenced to OnTime, w/ income only
# transition_simp_mod_m1_ontime <- lm( success ~ income + grad_late_refd_to_ontime + grad_none_refd_to_ontime, 
#                                      data = this_dat)
# # Graduation referenced to None, w/ income only
# transition_simp_mod_m1_none  <- lm( success ~ income + grad_late_refd_to_none + grad_ontime_refd_to_none, 
#                                     data = this_dat)
# 
# # Graduation referenced to OnTime, w/ income and illiteracy
# transition_simp_mod_m2_ontime <- lm( success ~ income + illiteracy + grad_late_refd_to_ontime + grad_none_refd_to_ontime, 
#                                      data = this_dat)
# # Graduation referenced to None, w/ income and illiteracy
# transition_simp_mod_m2_none  <- lm( success ~ income + illiteracy + grad_late_refd_to_none + grad_ontime_refd_to_none, 
#                                     data = this_dat)
# 
# # Model performance checks for all models
# # performance::check_model(transition_simp_mod_m1_ontime)
# # performance::check_model(transition_simp_mod_m1_none)
# # performance::check_model(transition_simp_mod_m2_ontime)
# # performance::check_model(transition_simp_mod_m2_none)

```


### Residuals & Assumptions

Descriptives section already checked normality so here we need to focus on linearity and homoscedasticity. We're  
going to center the data outright because I don't want to run everything multiple times.

```{r residuals_figures}
# 
# # Check Residuals plot (Heteroscedasticity)
# # Fitted values vs. residuals to examine homoscedasticity
# # NOTE use of .resid to plot residuals
# 
# 
# # MODEL 1 RESIDUALS: transition ~ income + illiteracy + grad_refd_to_ontime
# transition_resid_m1_ot_fig = ggplot( transition_simp_mod_m1_ontime, aes(.fitted, .resid) )
# 
# transition_resid_m1_ot_fig +
#     geom_point(col = font_color) +
#     geom_hline(yintercept=0, col="green3", linetype="dashed") +
#     xlab("Fitted Transition Success Values (0 - 10)") +
#     ylab("Success Residuals (0 - 10)") +
#     ggtitle("Model 1 Transition Success Residual vs. Fitted Plot - Ref Ontime Grad") +
#     my_gg_theme
# 
# # I also want to see a residuals plot in multiples of SD of productivity to help spot outliers
# transition_resid_sd_m1_ot_fig = ggplot( transition_simp_mod_m1_ontime,
#                                   aes(.fitted , .resid / transition_descr_comb$descriptives$asDF$`success[sd]` )
#                                 )
# 
# transition_resid_sd_m1_ot_fig +
#     geom_point(col = font_color) +
#     geom_hline(yintercept=0, col="green3", linetype="dashed") +
#     xlab("Fitted Transition Success Values") +
#     ylab(expression( "Residuals - Standardized (Multiples of " * sigma * ")") )  +
#     ggtitle("Model 1 Transition Success Residual vs. Fitted Plot - Ref Ontime Grad") +
#     my_gg_theme
# 
# # MODEL 1 RESIDUALS: transition ~ income + illiteracy + grad_refd_to_none
# transition_resid_m1_no_fig = ggplot( transition_simp_mod_m1_none, aes(.fitted, .resid) )
# 
# transition_resid_m1_no_fig +
#     geom_point(col = font_color) +
#     geom_hline(yintercept=0, col="green3", linetype="dashed") +
#     xlab("Fitted Transition Success Values (0 - 10)") +
#     ylab("Success Residuals (0 - 10)") +
#     ggtitle("Model 1 Transition Success Residual vs. Fitted Plot - Ref No Grad") +
#     my_gg_theme
# 
# # I also want to see a residuals plot in multiples of SD of productivity to help spot outliers
# transition_resid_sd_m1_no_fig = ggplot( transition_simp_mod_m1_none,
#                                   aes(.fitted , .resid / transition_descr_comb$descriptives$asDF$`success[sd]` )
#                                 )
# 
# transition_resid_sd_m1_no_fig +
#     geom_point(col = font_color) +
#     geom_hline(yintercept=0, col="green3", linetype="dashed") +
#     xlab("Fitted Transition Success Values") +
#     ylab(expression( "Residuals - Standardized (Multiples of " * sigma * ")") )  +
#     ggtitle("Model 1 Transition Success Residual vs. Fitted Plot - Ref No Grad") +
#     my_gg_theme
# 
# # MODEL 2 RESIDUALS: transition ~ income + illiteracy + grad_refd_to_ontime
# transition_resid_m2_ot_fig = ggplot( transition_simp_mod_m2_ontime, aes(.fitted, .resid) )
# 
# transition_resid_m2_ot_fig +
#     geom_point(col = font_color) +
#     geom_hline(yintercept=0, col="green3", linetype="dashed") +
#     xlab("Fitted Transition Success Values (0 - 10)") +
#     ylab("Success Residuals (0 - 10)") +
#     ggtitle("Model 2 Transition Success Residual vs. Fitted Plot - Ref Ontime Grad") +
#     my_gg_theme
# 
# # I also want to see a residuals plot in multiples of SD of productivity to help spot outliers
# transition_resid_sd_m2_ot_fig = ggplot( transition_simp_mod_m2_ontime,
#                                   aes(.fitted , .resid / transition_descr_comb$descriptives$asDF$`success[sd]` )
#                                 )
# 
# transition_resid_sd_m2_ot_fig +
#     geom_point(col = font_color) +
#     geom_hline(yintercept=0, col="green3", linetype="dashed") +
#     xlab("Fitted Transition Success Values") +
#     ylab(expression( "Residuals - Standardized (Multiples of " * sigma * ")") )  +
#     ggtitle("Model 2 Transition Success Residual vs. Fitted Plot - Ref Ontime Grad") +
#     my_gg_theme
# 
# # MODEL 2 RESIDUALS: transition ~ income + illiteracy + grad_refd_to_none
# transition_resid_m2_no_fig = ggplot( transition_simp_mod_m2_none, aes(.fitted, .resid) )
# 
# transition_resid_m2_no_fig +
#     geom_point(col = font_color) +
#     geom_hline(yintercept=0, col="green3", linetype="dashed") +
#     xlab("Fitted Transition Success Values (0 - 10)") +
#     ylab("Success Residuals (0 - 10)") +
#     ggtitle("Model 2 Transition Success Residual vs. Fitted Plot - Ref No Grad") +
#     my_gg_theme
# 
# # I also want to see a residuals plot in multiples of SD of productivity to help spot outliers
# transition_resid_sd_m2_no_fig = ggplot( transition_simp_mod_m2_none,
#                                   aes(.fitted , .resid / transition_descr_comb$descriptives$asDF$`success[sd]` )
#                                 )
# 
# transition_resid_sd_m2_no_fig +
#     geom_point(col = font_color) +
#     geom_hline(yintercept=0, col="green3", linetype="dashed") +
#     xlab("Fitted Transition Success Values") +
#     ylab(expression( "Residuals - Standardized (Multiples of " * sigma * ")") )  +
#     ggtitle("Model 2 Transition Success Residual vs. Fitted Plot - Ref No Grad") +
#     my_gg_theme

```

### Homscedasticity Checks

Just to throw the kitchen sink at the problem, we'll run BP tests on all 4 models.

```{r homoscedasticity_checks}
# # Run a Breusch Pagan Test of homoscedasticity for both models, for both reference grad values
# 
# cat( paste("  ", "---- Breusch-Pagan MODEL 1 - OnTime Ref ----", " ", sep = "\n") )
# car::ncvTest(transition_simp_mod_m1_ontime)
# 
# cat( paste("  ", "---- Breusch-Pagan MODEL 1 - None Ref ----", " ", sep = "\n") )
# car::ncvTest(transition_simp_mod_m1_none)
# 
# cat( paste("  ", "---- Breusch-Pagan MODEL 2 - OnTime Ref ----", " ", sep = "\n") )
# car::ncvTest(transition_simp_mod_m2_ontime)
# 
# cat( paste("  ", "---- Breusch-Pagan MODEL 2 - None Ref ----", " ", sep = "\n") )
# car::ncvTest(transition_simp_mod_m2_none)
```

### Data Cleaning - OPTIONAL
At first glance there was no need to revisit the data (clean the data), but this is kept here as a placeholder

``` {r data_cleaning_raw}

```

### Add Centered Data

We center our predictors for both datasets so regression tables can be built using centered data explicitly if so  
needed

```{r center_data}

# Center all continuous predictor data for models. We DON'T center outcome var (transition success) or categorical vars  
# (HS graduation times)
this_dat$fa_cent      <- this_dat$fa - mean(this_dat$fa)
this_dat$ppr_cent     <- this_dat$ppr - mean(this_dat$ppr)
# this_dat$p_mod_f_cent <- this_dat$p_mod_f - mean(this_dat$p_mod_f) # THIS DOESN'T WORK, WRONG WAY TO CRATE A CENTERED
#                                                                    # MODERATOR
this_dat$p_mod_f_cent <- this_dat$ppr_cent * this_dat$fa_cent

```

### Build Multiple Regression Models

We're going to build up the regression model one predictor at a time. First we'll look at how well family adversity  
predicts aggresive behavior. Then we'll look at how adding positive peer relationships into the mix impacts childhood  
aggression, and then we'll study how much positive peer relationships affects family adversity's impact on childhood   
aggression.

#### UnCentered Regression w/ PPR moderating FA

```{r multiple_regression_uncentered_ref_ot}
cat( 
     paste(
           '----------------------------------------------------------------------------------',
           '---- UnCentered Multiple Regression Model w/ PPR Moderating Family Attributes ----',
           '----------------------------------------------------------------------------------',
           sep = '\n'
     ) 
   )

# 
moderated_regr_uc <- linReg( this_dat,
                             dep = 'agg',
                             covs = c('fa', 'ppr', 'p_mod_f'),
                             blocks = list(
                                            list( 'fa' ),
                                            list( 'ppr' ),
                                            list( 'p_mod_f' )
                                          ),
                             modelTest = TRUE,
                             stdEst = TRUE,
                             r2Adj = TRUE,
                             collin = TRUE,
                             ci = TRUE)
moderated_regr_uc

```

#### Centered Regression w/ PPR moderating FA

Centered data with Peer Support Moderating Family Attributes

```{r multiple_regression_centered_ref_ot}
cat( 
     paste(
           '--------------------------------------------------------------------------------',
           '---- Centered Multiple Regression Model w/ PPR Moderating Family Attributes ----',
           '--------------------------------------------------------------------------------',
           sep = '\n'
     ) 
   )

# Centered
moderated_regr_cent <- linReg( this_dat,
                               dep = 'agg',
                               covs = c('fa_cent', 'ppr_cent', 'p_mod_f_cent'),
                               blocks = list(
                                              list( 'fa_cent' ),
                                              list( 'ppr_cent' ),
                                              list( 'p_mod_f_cent' )
                                            ),
                               modelTest = TRUE,
                               stdEst = TRUE,
                               r2Adj = TRUE,
                               collin = TRUE,
                               ci = TRUE)
moderated_regr_cent

```

### Simple Slopes Analyses

#### Non-Standardized Simple Slopes Analysis

```{r unstd_simp_slop} 
#Unstandardized Simple Slopes Analysis

# Fit model with raw variables
unstd_model <- lm(agg ~ ppr * fa, data = this_dat)

# Now run simple slopes 
# NOTE: For these functions, we have to explicitly note who our perdictor is and who our moderator is
sim_slopes(unstd_model, pred = "fa", modx = "ppr")

# Plot interaction
interact_plot(unstd_model, pred = "fa", modx = "ppr")
```

#### Standard Simple Slopes Analysis

```{r}
# Something doesn't work in the code below, pulled from Dr. D's example. We get data format and interaction errors.

#Standardized Simple Slopes Analysis

# Fully standardize model automatically
# NOTE: This generates the same thing as above, but for a centered (standardized model)
std_model <- effectsize::standardize(unstd_model)

# Now run simple slopes
sim_slopes(std_model, pred = "fa", modx = "ppr")

# Plot interaction
interact_plot(std_model, pred = "fa", modx = "ppr")

```
