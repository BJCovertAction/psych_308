---
title: "PSYCH308C - Data Analysis 02 (DA02)"
author: "Brady C. Jackson"
date: "2025/01/28"

# Write document output to HTML, Word, and PDF output types with a Table of
# contents included.
output: 
  html_document:
    toc: true
  word_document:
    toc: true
  pdf_document:
    toc: true
    latex_engine: xelatex

# This option here enables output to both HTML and PDF formats
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding,
  output_format = "all") })
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

---

```{r package_loading, message=FALSE, warning=FALSE}

# Load packages. Set messages and warnings to FALSE so I don't have to see the
# masking messages in the output.
library(car)
library(psych)
library(jmv)
library(magrittr)
library(rlang)
library(mvnTest)
library(dplyr)
library(easystats)
library(patchwork)
library(mvtnorm)
library(ggplot2)
```

## Prompt

A university wants to offer courses to their students that will maximize their success after college. Their first step   
is determining which qualities are important to consider in determining the success of college students transitioning to   
the work force. In their final semester of college, each participants' advisor rated them on professionalism,   
competence, and motivation. Six months after graduation, each participants' supervisor rated their success in their role   
thus far. After collecting data on 278 participants, it is time to test the research team's models! Researcher 1   
predicts that a model including professionalism and competence will predict their success. Researcher 2 predicts that   
professionalism, competence, and motivation will predict success. Take the necessary steps to run both model 1   
(professionalism and competence) and model 2 (professionalism, competence, and motivation). 

## Variables 

| Variable | Type | Description |
|:-----|:---|:------------------|
| `Professionalism` | 1-7 scale | Score on professionalism rated by advisor |
| `Competence` | 1-7 scale | Score on competence rated by advisor |
| `Motivation` | 1-7 scale | Score on motivation rated by advisor |
| `Success` | 1-100 scale | Score on success rated by supervisor |

## Assignment


### Metadata

This section of code is to setup some general variables that we'll use throughout the code (e.g. figure colors, etc)

```{r metadata}
# First we'll defines some meta-data to use in all of our plots so they're nice and clean
font_color = "#4F81BD"
grid_color_major = "#9BB7D9"
grid_color_minor = "#C8D7EA"
back_color = "gray95"
rb_colmap = colorRampPalette( c("firebrick", "grey86", "dodgerblue3") )(200)

```

### Load and View data

```{r load_raw_data}

# Load data as downloaded from Canvas
success_raw_dat = read.csv("./308C.DA2 Data.csv")

# Rename columns to lower because why not
colnames(success_raw_dat) <- tolower( colnames(success_raw_dat) )

# View data
glimpse(success_raw_dat)

# Ensure that the employee numbers of each subject in the study are unique to prevent any duplicate data
# if the size of the unique-entries only is the same as the whole vector then there are no duplicate subjects
test_unique = (length(unique(success_raw_dat$subject)) == length(success_raw_dat$subject))
if(!test_unique){
    print("WARNING: There are duplicate data entries in the raw data")
}else{
    print("No duplicate entries detected in raw data")
}
```

### Descriptive Statistics - Raw Data

This section will look at base descriptive statistics of the raw data to help identify data anomalies and check   
normality of predictor variables (break length - minutes)

```{r descriptive_stats_raw}

# SAMPLE CODE
# # Get JMV descriptives of raw productivity, enjoyment, and break length
# # Tabulate mean, variance, skew, and kurtosis so we can check normality.
# # Output histograms and qq plots so we can spot outliers and review distribution shape
# success_descr = jmv::descriptives( success_raw_dat[c(2:4)],
#                                   hist = TRUE,
#                                   dens = TRUE,
#                                   qq = TRUE,
#                                   sd = TRUE, 
#                                   variance = TRUE,
#                                   se = TRUE, 
#                                   skew = TRUE, 
#                                   kurt = TRUE,
#                                   missing = TRUE)
# print(success_descr)

```

### Correlation Plots - Raw Data

Visualize the covariance matrix to understand correlation between break length and employee productivity


```{r correlation_plots_raw}

# SAMPLE CODE
# # Given that we're working explicitly on break length and productivity, I want to create a second dataframe that 
# # consists only of those columns for simplicity. I'll maintain the original as well so I can get some insight into
# # employee enjoyment as well, but since that's not the focus I want a clean dataset as well.
# success_dat <- success_raw_dat
# success_dat$subject <- NULL
# success_dat$enjoy <- NULL
# 
# # Produce a correlation matrix plot that includes the numbers printed with a color gradient for easy reading.
# # par(bg = "lightgrey")
# success_full_cor <- stats::cor(success_raw_dat)
# corrplot( success_full_cor, 
#           method="color", 
#           type = "full", 
#           addCoef.col = "black", 
#           col = rb_colmap, 
#           tl.col = font_color )
# 
# success_short_cor <- stats::cor(success_dat)
# corrplot( success_short_cor, 
#           method="color", 
#           type = "full",  
#           addCoef.col = "black", 
#           col = rb_colmap,  
#           tl.col = font_color )
# 
# 
# # Print correlation tables (annoying that we have to use two different correlation functions, 1 for plotting and
# # 1 for tables, but oh well)
# success_full_cor_tab <- jmv::corrMatrix(success_raw_dat[2:4], flag = TRUE)
# print(success_full_cor_tab)
# 
# success_short_cor_tab <- jmv::corrMatrix(success_dat, flag = TRUE)
# print(success_short_cor_tab)
# 
# # Finally dump a correlation table to Word Doc format for easy table formatting / to save time in writing
# # the assignment
# apa.cor.table( success_raw_dat[2:4], 
#                filename = "full_corr_table_success_v_prod.doc", 
#                table.number = 1, 
#                show.sig.stars = TRUE, 
#                landscape = TRUE)
# 
# apa.cor.table( success_dat, 
#                filename = "short_corr_table_success_v_prod.doc", 
#                table.number = 1, 
#                show.sig.stars = TRUE, 
#                landscape = TRUE)

```

### Assumptions, Figures, and Plots - Raw Data

Descriptives section already checked normality so here we need to focus on linearity and homoscedasticity. We're  
going to center the data outright because I don't want to run everything multiple times.

```{r assumptions_and_figures_raw}

# SAMPLE CODE
# # Centering the data
# success_dat$length_centered <- success_dat$length - mean(success_dat$length)
# 
# 
# # Check Scatterplot of Centered data: Break Length is PV, Productivity is OV
# success_raw_scatter <- ggplot(success_dat, aes(length, product) )
# 
# success_raw_scatter + 
#     geom_point() + 
#     geom_smooth(method = "lm", colour = "Red") + 
#     ggtitle("Break Length Relation to Employee Productivity") + 
#     labs(x = "Break Length (m)", y = "Employee Productivity (0-100)") +
#     theme_minimal() +
#     theme( plot.title = element_text(size = 12, face = "italic", color = font_color),
#            axis.title.x = element_text(color = font_color),
#            axis.title.y = element_text(color = font_color),
#            axis.text.x = element_text(color = font_color),
#            axis.text.y = element_text(color = font_color),
#            legend.title = element_text(color = font_color),
#            legend.text = element_text(color = font_color),
#            panel.grid.minor = element_line(color = grid_color_minor),
#            panel.grid.major = element_line(color = grid_color_major),
#            panel.background = element_rect(fill = back_color, color = font_color)
#          )
# 
# success_cent_scatter <- ggplot(success_dat, aes(length_centered, product) )
# 
# success_cent_scatter + 
#     geom_point() + 
#     geom_smooth(method = "lm", colour = "Red") + 
#     ggtitle("Break Length Relation to Employee Productivity") + 
#     labs(x = "Break Length - Centered (m)", y = "Employee Productivity (0-100)") +
#     theme_minimal() +
#     theme( plot.title = element_text(size = 12, face = "italic", color = font_color),
#            axis.title.x = element_text(color = font_color),
#            axis.title.y = element_text(color = font_color),
#            axis.text.x = element_text(color = font_color),
#            axis.text.y = element_text(color = font_color),
#            legend.title = element_text(color = font_color),
#            legend.text = element_text(color = font_color),
#            panel.grid.minor = element_line(color = grid_color_minor),
#            panel.grid.major = element_line(color = grid_color_major),
#            panel.background = element_rect(fill = back_color, color = font_color)
#          )
# 
# 
# # Check Residuals plot (Heteroscedasticity)
# # To compute residuals we need to define the model as productivity regressed onto break length in a linear fashion
# success_model_lin <- lm(product ~ length, data = success_dat)
# 
# # Fitted values vs. residuals to examine homoscedasticity
# # NOTE use of .resid to plot residuals
# success_resid_fig = ggplot( success_model_lin, aes(.fitted, .resid) )
# 
# success_resid_fig + 
#     geom_point(col = font_color) +
#     geom_hline(yintercept=0, col="green3", linetype="dashed") +
#     xlab("Fitted Productivity Values (0 - 100)") +
#     ylab("Productivity Residuals (0 - 100)") +
#     ggtitle("Residual vs. Fitted Plot") +
#     theme_minimal() +
#     theme( plot.title = element_text(size = 12, face = "italic", color = font_color),
#            axis.title.x = element_text(color = font_color),
#            axis.title.y = element_text(color = font_color),
#            axis.text.x = element_text(color = font_color),
#            axis.text.y = element_text(color = font_color),
#            legend.title = element_text(color = font_color),
#            legend.text = element_text(color = font_color),
#            panel.grid.minor = element_line(color = grid_color_minor),
#            panel.grid.major = element_line(color = grid_color_major),
#            panel.background = element_rect(fill = back_color, color = font_color)
#          )
# 
# # I also want to see a residuals plot in multiples of SD of productivity to help spot outliers
# success_resid_sd_fig = ggplot( success_model_lin, aes(.fitted , .resid / success_descr$descriptives$asDF$`product[sd]` ) )
# 
# success_resid_sd_fig + 
#     geom_point(col = font_color) +
#     geom_hline(yintercept=0, col="green3", linetype="dashed") +
#     xlab("Fitted Productivity Values") +
#     ylab(expression( "Residuals - Standardized (Multiples of " * sigma * ")") )  +
#     ggtitle("Productivity Residual vs. Fitted Plot") +
#     theme_minimal() +
#     theme( plot.title = element_text(size = 12, face = "italic", color = font_color),
#            axis.title.x = element_text(color = font_color),
#            axis.title.y = element_text(color = font_color),
#            axis.text.x = element_text(color = font_color),
#            axis.text.y = element_text(color = font_color),
#            legend.title = element_text(color = font_color),
#            legend.text = element_text(color = font_color),
#            panel.grid.minor = element_line(color = grid_color_minor),
#            panel.grid.major = element_line(color = grid_color_major),
#            panel.background = element_rect(fill = back_color, color = font_color)
#          )  
# 
# # Run a Breusch Pagan Test of homoscedasticity
# car::ncvTest(success_model_lin)
```

### Data Cleaning - OPTIONAL
If there are data issues that need to be adjusted, clean the data here.

``` {r data_cleaning_raw}

```

### Build Simple Regression Model

Centered data is already saved from scatter plots above (shift the y-intercept to the mean of the dataset).  
Now we can build the regression model.  

```{r simple_regression}

# SAMPLE CODE
# #simple regression looking at self-efficacy (centered) as a predictor of desire to lead in a group (e.g. self-efficacy (centered) regressed on desire to lead)
# success_model_lin_reg <- linReg( data = success_dat, 
#                                 dep = 'product', 
#                                 covs = c('length_centered'), 
#                                 blocks = list( c( 'length_centered') ), 
#                                 modelTest = TRUE, 
#                                 stdEst = TRUE,
#                                 ci = TRUE)
# success_model_lin_reg


```

### APA Tables

Output regression tables to an APA formatted (almost) word doc in case that's useful

```{r apa_tables}
# We'll define a new linear model using the centered data.

# SAMPLE CODE:
# Define a linear model
# success_model_lin_centered <- lm(product ~ length_centered, data = success_dat)

# Use reg.table method in APA package to generate regression table
# apa.reg.table( success_model_lin_centered, filename="prod_regressed_to_breaks.doc", table.number = 2 )

```
