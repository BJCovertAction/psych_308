---
title: "PSYCH308D - Capstone Data Analysis"
author: "Brady C. Jackson"
date: "2025/04/28"

# Write document output to HTML, Word, and PDF output types with a Table of
# contents included.
output: 
  html_document:
    toc: true
  word_document:
    toc: true
  pdf_document:
    toc: true
    latex_engine: xelatex

# This option here enables output to both HTML and PDF formats
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding,
  output_format = "all") })
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

---

# Libraries

Load all requisite libraries here.

```{r package_loading, message=FALSE, warning=FALSE}
# Load packages. Set messages and warnings to FALSE so I don't have to see the
# masking messages in the output.
library(jmv)       # for descriptive
library(ggplot2)
library(dplyr)
library(corrplot)    # For fancy covariance matrix plots
library(apaTables)   # For Word formatted tables
library(car)         # for ncvTest (Breusch Pagan)
library(tidyverse)
library(jmv)       # for descriptive
library(ggplot2)
library(dplyr)
library(psych)
library(corrplot)    # For fancy covariance matrix plots
library(car)         # for ncvTest (Breusch Pagan)
library(stringr)     # for sub_str operations
library(Hmisc)       # for fun.dat substitution
library(see)         # for outliers analysis 
library(magrittr)
library(foreign)
library(broom)
library(robmed)
library(mediation)   # For mediation analysis
library(multilevel)
library(GGally)
library(lsr)
library(car)
library(mvnTest)     # Multivariate Normality
library(lm.beta)
library(lavaan)      # Structural Equation Modeling
library(haven)
library(foreign)
library(parallel)
# library(AER)

source("~/.Rprofile")

```

# Metadata

This section of code is to setup some general variables that we'll use throughout the code (e.g. figure colors, etc)

```{r metadata}
# First we'll defines some meta-data to use in all of our plots so they're nice and clean
font_color = "#4F81BD"
grid_color_major = "#9BB7D9"
grid_color_minor = "#C8D7EA"
back_color = "gray95"
rb_colmap = colorRampPalette( c("firebrick", "grey86", "dodgerblue3") )(200)

# I'm going to try to save off my preferred ggplot theme combinations as a unqiue theme object that I can just reference
# later in the code....totally unclear if ggplot works this way....
my_gg_theme = theme_minimal() +
              theme( plot.title = element_text(size = 12, face = "italic", color = font_color),
                     axis.title.x = element_text(color = font_color),
                     axis.title.y = element_text(color = font_color),
                     axis.text.x = element_text(color = font_color),
                     axis.text.y = element_text(color = font_color),
                     legend.title = element_text(color = font_color),
                     legend.text = element_text(color = font_color),
                     panel.grid.minor = element_line(color = grid_color_minor),
                     panel.grid.major = element_line(color = grid_color_major),
                     panel.background = element_rect(fill = back_color, color = font_color)
                   )

# Extract cores for parallel processing. We want to use all but 2 threads in the system
n_cores   <- detectCores()
use_cores <- n_cores - 2
# use_cores <- n_cores / 2 - 1

```

# Load and View data

Here we load the dataframes with our project data from the previously saved RDS file.


```{r load_data}

# Load the assignment data from CSV
my_dfs <- readRDS("./all_cleaned_humor_data.rds")

augment_dat <- my_dfs$augment_dat
clean_cent_dat <- my_dfs$clean_cent_dat
clean_std_dat <- my_dfs$clean_std_dat
cont_vars <- my_dfs$cont_vars

# Force correct datatypes
clean_cent_dat$seen_dark_dc <- as.numeric(clean_cent_dat$seen_dark_dc)

```

# Assumption Checks

## Define Vars to Check Assumptions On

We don't need to evaluate descriptives and assumptions for everything in our dataset. We only need to focus on
 avg_stai_before   
 avg_stai_mid   
 humor_preference   
 
... so we define them as a subset for assumption checksing

```{r def_analysis_vars}
analysis_cont_vars <- c("avg_stai_before", "avg_stai_mid", "humor_pref_cont")
analysis_cat_vars  <- c("humor_congruence", "cong_dc", "incong_dc")
 
```


## Descriptive Statistics - All - Centered Data

We reprint statistics of all relevant continuous variables here for assumption checking

```{r descriptive_stats_cent}

# We'll need to check both univariate normality and multi-variate normality.
#    NOTE: We need to use the vars = cont_names[] syntax with [] included to access the contents of
#          cont_names. Otherwise jamovi recognizes it as a character array object and it craps out.
my_descr = jmv::descriptives( clean_cent_dat,
                              vars = cont_vars[],
                              hist = TRUE,
                              dens = TRUE,
                              qq = TRUE,
                              sd = TRUE,
                              variance = TRUE,
                              se = TRUE,
                              skew = TRUE,
                              kurt = TRUE,
                              missing = TRUE
                            )
print(my_descr)

```

## Descriptive Statistic - All -  Uncentered

All continuous variables, uncentered so we can see means

```{r descriptives_uncent_all}
uc_descr = jmv::descriptives( augment_dat,
                              vars = cont_vars[],
                              hist = TRUE,
                              dens = TRUE,
                              qq = TRUE,
                              sd = TRUE,
                              variance = TRUE,
                              se = TRUE,
                              skew = TRUE,
                              kurt = TRUE,
                              missing = TRUE
                            )
print(uc_descr)

```

## Descriptive Statistic - Analysis Only -  Uncentered - w/ No Preference Included

Analysis variables only, uncentered, unsplit

```{r descriptives_uncent_an}
an_uc_descr = jmv::descriptives( augment_dat,
                                 vars = analysis_cont_vars[],
                                 hist = TRUE,
                                 dens = TRUE,
                                 qq = TRUE,
                                 sd = TRUE,
                                 variance = TRUE,
                                 se = TRUE,
                                 skew = TRUE,
                                 kurt = TRUE,
                                 missing = TRUE
                            )
print(an_uc_descr)

```


## Descriptive Statistic - Analysis Only -  Uncentered - Split by Pref

Analysis variables only, split by humor type, uncentered

```{r descriptives_uncent_an_split}
an_sp_uc_descr = jmv::descriptives( augment_dat,
                                    vars = analysis_cont_vars[],
                                    splitBy = "humor_pref_type",
                                    hist = TRUE,
                                    dens = TRUE,
                                    qq = TRUE,
                                    sd = TRUE,
                                    variance = TRUE,
                                    se = TRUE,
                                    skew = TRUE,
                                    kurt = TRUE,
                                    missing = TRUE
                                 )
print(an_sp_uc_descr)

```

## Correlation Plots - Centered Data - All

Visualize the covariance matrix to understand correlation between continuous vars in dataset


```{r correlation_plots_all}

# We look at correlations for the centered data for ease of interpretation (and because it's the same for cent and
# uncent)

# Centered correlations.
cent_subset <- clean_cent_dat[ cont_vars ]
corr_cent   <- stats::cor( cent_subset )
corrplot( corr_cent,
          method="color",
          type = "full",
          addCoef.col = "black",
          col = rb_colmap,
          tl.col = font_color )

# Print correlation tables (annoying that we have to use two different correlation functions, 1 for plotting and
# 1 for tables, but oh well)
corr_cent_tab <- jmv::corrMatrix(cent_subset, flag = TRUE)
print( corr_cent_tab )

```


## Correlation Plots - Centered Data - Analysis Vars Only

Visualize the covariance matrix of continuous variables were analyzing to understand correlations between continuous  
vars in models.  

```{r correlation_plots_an}

# We look at correlations for the centered data for ease of interpretation (and because it's the same for cent and
# uncent)

# Centered correlations.
cent_subset_an <- clean_cent_dat[ analysis_cont_vars ]
corr_cent_an   <- stats::cor( cent_subset_an )
corrplot( corr_cent_an,
          method="color",
          type = "full",
          addCoef.col = "black",
          col = rb_colmap,
          tl.col = font_color )

# Print correlation tables (annoying that we have to use two different correlation functions, 1 for plotting and
# 1 for tables, but oh well)
corr_cent_an_tab <- jmv::corrMatrix(cent_subset_an, flag = TRUE)
print( corr_cent_an_tab )

```


## Scatterplots of Variables - Uncentered

We need to check avg_stai_mid as a function of both avg_stai_before and humor_pref_cont to evaluate linearity.  
Notice these scatterplots are not split by humor type but if we need to do that we can.  

```{r scatter_plots}

# Scatterplot 1: T2 anxiety vs. T1 Anxiety  (uncentered)
anx_scatter_func <- ggplot(augment_dat, aes(x = avg_stai_before, y = avg_stai_mid) )

anx_scatter_func +
geom_point() +
     geom_smooth(method = "lm", colour = "Red") +
     ggtitle("Anxiety at Time 2 vs. Anxiety at Time 1") +
     labs(y = "Anxiety at T2 (1-10)", x = "Anxiety at T1 (1-10)") +
     my_gg_theme


# Scatterplot 2: T2 Anxiety vs. Humor Preference Continuum  (uncentered)
anx_v_hp_scatter_ppruc <- ggplot(augment_dat, aes(x = humor_pref_cont, y = avg_stai_mid) )

anx_v_hp_scatter_ppruc +
     geom_point() +
     geom_smooth(method = "lm", colour = "Red") +
     ggtitle("Anxiety at Time 2 vs. Humor Preference") +
     labs(y = "Anxiety at T2 (1-10)", x = "Humor Preference (-10 -> 10) (< 0 = Dark)") +
     my_gg_theme

```

## Scatterplots of Variables - Uncentered - Split by Humor Type

Here we split the Humor Preference scatterplot by humor type for further inspection   

```{r scatter_plots_split}

# We'll use the indices defined below to subset our scatterplot data
lt_ids <- (augment_dat$humor_pref_type == "light")
dk_ids <- (augment_dat$humor_pref_type == "dark")
no_ids <- (augment_dat$humor_pref_type == "neither")

# Subset our dataframe 3 times to get the pieces we need
lt_dat <- augment_dat[lt_ids, ]
dk_dat <- augment_dat[dk_ids, ]
no_dat <- augment_dat[no_ids, ]

# Scatterplot 3a: T2 Anxiety vs. Humor Preference Continuum - Light (uncentered)
anx_v_hp_scatter_lt_pp <- ggplot(lt_dat, aes(x = humor_pref_cont, y = avg_stai_mid) )

anx_v_hp_scatter_lt_pp +
     geom_point() +
     geom_smooth(method = "lm", colour = "Red") +
     ggtitle("Anxiety at Time 2 vs. Light Humor Preference") +
     labs(y = "Anxiety at T2 (1-10)", x = "Humor Preference (0.05 - 10)") +
     my_gg_theme

# Scatterplot 3b: T2 Anxiety vs. Humor Preference Continuum - Dark (uncentered)
anx_v_hp_scatter_dk_pp <- ggplot(dk_dat, aes(x = humor_pref_cont, y = avg_stai_mid) )

anx_v_hp_scatter_dk_pp +
     geom_point() +
     geom_smooth(method = "lm", colour = "Red") +
     ggtitle("Anxiety at Time 2 vs. Dark Humor Preference") +
     labs(y = "Anxiety at T2 (1-10)", x = "Humor Preference (-10 -> 0.05)") +
     my_gg_theme

# Scatterplot 3c: T2 Anxiety vs. Humor Preference Continuum - No Preference (uncentered)
anx_v_hp_scatter_no_pp <- ggplot(no_dat, aes(x = humor_pref_cont, y = avg_stai_mid) )

anx_v_hp_scatter_no_pp +
     geom_point() +
     geom_smooth(method = "lm", colour = "Red") +
     ggtitle("Anxiety at Time 2 vs. No Humor Preference") +
     labs(y = "Anxiety at T2 (1-10)", x = "Humor Preference (-0.05 -> 0.05)") +
     my_gg_theme

```

## Construct Moderation Variables

### Moderation Vars for Model Codename Slapstick

```{r slapstick_mod_vars}

# For our slapstick model, we need to multiply each of our congruence dummy vars (cong_dc, incong_dc) times 
# our moderated PV  humor_pref_cont

# We must use centered values. This has congruence categories moderating the relationship between
# humor preference and mid anxiety
clean_cent_dat$cong_x_hp   <- clean_cent_dat$cong_dc * clean_cent_dat$humor_pref_cont  # Moderated by Congurent Piece
clean_cent_dat$incong_x_hp <- clean_cent_dat$incong_dc * clean_cent_dat$humor_pref_cont   # Moderated by Incongruent Piece

# We must use centered values.  This has congruence categories moderating the relationship between
# initial anxiety and mid anxiety
clean_cent_dat$cong_x_anx   <- clean_cent_dat$cong_dc * clean_cent_dat$avg_stai_before  # Moderated by Congurent Piece
clean_cent_dat$incong_x_anx <- clean_cent_dat$incong_dc * clean_cent_dat$avg_stai_before   # Moderated by Incongruent Piece

# Relocate new vars for readability
clean_cent_dat <- clean_cent_dat %>% relocate(c("cong_x_hp", "incong_x_hp"), .after=incong_dc)

```

## Build Simple Linear Models (lm)

```{r linear_model_definition}

# We have two basic models we look at, Slapstick and GlitterBomb
#  Slapstick includes humor_pref_cont, avg_stai_before, and moderation terms cong_x_hp and incong_x_hp
#  Glitterbomb includes humor_pref_cont, avg_stai_before, and cong_dc (cat PV), and cong_x_hp on the dataset with
#   no-preference entries removed. We'll create both here so we can evaluate residuals of the models for reviewing
#   heteroscedasticity


# Reduce the cleaned and centered dataset down to one without any no-preference types
clean_cent_dat_red <- clean_cent_dat[clean_cent_dat$humor_pref_type != "neither", ]

# Build the linear models
slapstick_lm   <- lm(avg_stai_mid ~ avg_stai_before + 
                                    humor_pref_cont + 
                                    cong_x_hp + incong_x_hp,
                     
                     data = clean_cent_dat
                    )
glitterbomb_lm <- lm(avg_stai_mid ~ avg_stai_before + 
                                    humor_pref_cont +
                                    cong_dc + 
                                    cong_x_hp,
                     
                     data = clean_cent_dat_red
                    )


```

## Residuals Plots
```{r residuals_figures}

# # Check Residuals plot (Heteroscedasticity)
# # Fitted values vs. residuals to examine homoscedasticity
# # NOTE use of .resid to plot residuals
# 
# 
# # Main Effects: agg ~ fa + ppr
# agg_resid_me_fig = ggplot( agg_simp_mod_uc, aes(.fitted, .resid) )
# 
# agg_resid_me_fig +
#     geom_point(col = font_color) +
#     geom_hline(yintercept=0, col="green3", linetype="dashed") +
#     xlab("Fitted Childhood Aggression Levels (1-20)") +
#     ylab("Aggression Residuals (1 - 20)") +
#     ggtitle("Main Effects Childhood Aggression Residual vs. Fitted Plot") +
#     my_gg_theme
# 
# # I also want to see a residuals plot in multiples of SD of productivity to help spot outliers
# agg_resid_me_sd_fig = ggplot( agg_simp_mod_uc,
#                               aes(.fitted , .resid / my_descr$descriptives$asDF$`agg[sd]` )
#                             )
# 
# agg_resid_me_sd_fig +
#     geom_point(col = font_color) +
#     geom_hline(yintercept=0, col="green3", linetype="dashed") +
#     xlab("Fitted Childhood Aggression Levels (1-20)") +
#     ylab(expression( "Residuals - Standardized (Multiples of " * sigma * ")") )  +
#     ggtitle("Main Effects Childhood Aggression Residual vs. Fitted Plot") +
#     my_gg_theme
# 
# # Create Residuals plot for Fitted values with Moderation Accounted for
# 
# # Moderation Effects: agg ~ fa + ppr + p_mod_f
# agg_resid_mod_fig = ggplot( agg_me_w_mod_model_uc, aes(.fitted, .resid) )
# 
# agg_resid_mod_fig +
#     geom_point(col = font_color) +
#     geom_hline(yintercept=0, col="green3", linetype="dashed") +
#     xlab("Fitted Childhood Aggression Levels (1-20)") +
#     ylab("Aggression Residuals (1 - 20)") +
#     ggtitle("Main + Moderation Effects Childhood Aggression Residual vs. Fitted Plot") +
#     my_gg_theme
# 
# # I also want to see a residuals plot in multiples of SD of productivity to help spot outliers
# agg_resid_mod_sd_fig = ggplot( agg_me_w_mod_model_uc,
#                               aes(.fitted , .resid / my_descr$descriptives$asDF$`agg[sd]` )
#                             )
# 
# agg_resid_mod_sd_fig +
#     geom_point(col = font_color) +
#     geom_hline(yintercept=0, col="green3", linetype="dashed") +
#     xlab("Fitted Childhood Aggression Levels (1-20)") +
#     ylab(expression( "Residuals - Standardized (Multiples of " * sigma * ")") )  +
#     ggtitle("Main + Moderation Childhood Aggression Residual vs. Fitted Plot") +
#     my_gg_theme

```


## Homoscedasticity Checks
```{r homoscedasticity_checks}

# # Run a Breusch Pagan Test of homoscedasticity for both models, for both reference grad values
# 
# cat( paste("  ", "---- Breusch-Pagan Main Effects ----", " ", sep = "\n") )
# car::ncvTest(agg_simp_mod_uc)
# 
# cat( paste("  ", "---- Breusch-Pagan Main + Moderation Effects ----", " ", sep = "\n") )
# car::ncvTest(agg_me_w_mod_model_uc)


```


## Multi-Variate Normality

```{r multivar_norm}


# # Code below manually produces QQ Plot for better alignment with general plot styles
# ggplot(agg_simp_mod_uc, 
#          aes( 
#                qqnorm( .stdresid,
#                        xlab = "", ylab = "", 
#                        conf.level = 0.945, 
#                        conf.args = list(col = "lightgrey", exact = TRUE) 
#                       )[[1]],
#                .stdresid ) 
#        ) + 
#     geom_point(na.rm = TRUE) +
#     xlab("Theoretical Quantiles") + 
#     ylab("Standardized Residuals") +
#     ggtitle("Normal Q-Q of Main Effects Model") + 
#     my_gg_theme
# 
# # Henze-Zirkler test of multivariate normality
# # Columns 2-4 are Aggression, Family Adversity, and Positive Peer Support respectively.
# HZ.test(this_dat[2:4])


```

# Model Building

We're going to build two models. The first will use light_humor_avg and dark_humor_avg as predictor   
variables for change in anxiety, and those will both be moderated by order of humor seen (refernce level is light  
first seen). Age will be our control. ... This model will be called Giggles.

Our second model will use the light/dark preference categories as predictors (referenced to no preference). Those  
will also be moderated by order of video seen.... this model will be called GutBuster


## Build Regression Models

### Slapstick Regression

Model discussed in 4/29 workshop
Primary predictor is humor_pref_cont (light vs dark continuum)
Initial anxiety (avg_stai_before) is a control variable.
OV is avg_stai_mid, anxiety after viewing first video
Moderator is categorical variable humor_congruence, which is a categorical variable with two levels referenced to "none" 
  e.g. neither congruent nor incongruent because strong-humor preference not shown by subject.


```{r slapstick_model}

# # Ensure cong and incong are factors
# clean_cent_dat$cong_dc <- as.factor(clean_cent_dat$cong_dc)
# clean_cent_dat$incong_dc <- as.factor(clean_cent_dat$incong_dc)

# Full model we dicsussed is defined below. It CANNOT converge, so we had to settle for partial models as defined in the 
# on-commented models
# There's some multicollinearity bug preventing linReg from converging. Let's see if bootstrapping works instead...
# slapstick_regr <- linReg( clean_cent_dat,
#                           dep = 'avg_stai_mid',
#                           covs = c( 'avg_stai_before', 'humor_pref_cont',
#                                     'cong_dc', 'incong_dc',
#                                     'cong_x_hp', 'incong_x_hp'
#                                    ),
#                           blocks = list(
#                                          list( 'avg_stai_before' ),
#                                          list( 'humor_pref_cont'),
#                                          list( 'cong_dc', 'incong_dc'),
#                                          list( 'cong_x_hp', 'incong_x_hp' )
#                                        ),
#                           modelTest = TRUE,
#                           stdEst = TRUE,
#                           r2Adj = TRUE,
#                           collin = FALSE,
#                           ci = TRUE
#                         )
# 
# 
# 
# slapstick_regr

# We can run this model without the catvars as predictors of anxiety. That sheds the linearly dependent problem
slapstick_regr <- linReg( clean_cent_dat,
                          dep = 'avg_stai_mid',
                          covs = c( 'avg_stai_before', 'humor_pref_cont',
                                    'cong_dc', 'incong_dc',
                                    'cong_x_hp', 'incong_x_hp'
                                   ),
                          blocks = list(
                                         list( 'avg_stai_before' ),
                                         list( 'humor_pref_cont'),
                                         # list( 'cong_dc', 'incong_dc'),
                                         list( 'cong_x_hp', 'incong_x_hp' )
                                       ),
                          modelTest = TRUE,
                          stdEst = TRUE,
                          r2Adj = TRUE,
                          collin = TRUE,
                          ci = TRUE
                        )



slapstick_regr


# Using CENTERED vars -Bootstrapping because N=12 for neither congruent nor incongruent piece of dataset
#                      so we need a non-parametric method
slapstick_def <- '
                  ### F**** This model fails too... this categorical moderation doesnt seem to be working ***
                  # Primary regression path names followed by * are path names
                  # avg_stai_mid ~ bef_mid*avg_stai_before + 
                  #                hum_mid*humor_pref_cont +
                  #                cong_mid*cong_dc + incong_mid*incong_dc +
                  #                mod_cng_hum*cong_x_hp + mod_incng_hum*incong_x_hp
                  
                  # Covariances: NONE for NOW
                  avg_stai_before ~~ humor_pref_cont
                  
                  # Control Vars ONLY - No Other Predictors
                  # avg_stai_mid ~  bef_mid*avg_stai_before
                  
                  # Main Effects Only - Humor Only, no Cats
                  # avg_stai_mid ~ bef_mid*avg_stai_before + hum_mid*humor_pref_cont
                  
                  # Main Effects Only - Humor w/ Cats 
                  # avg_stai_mid ~ bef_mid*avg_stai_before + hum_mid*humor_pref_cont + cong_mid*cong_dc + incong_mid*incong_dc
                  
                  # Main Effects + Moderation Only - Humor w/ Moderation, no Cats
                  avg_stai_mid ~ bef_mid*avg_stai_before + hum_mid*humor_pref_cont + mod_cng_hum*cong_x_hp + mod_incng_hum*incong_x_hp
                  
                  # Moderated Effects Only - No Main Effects
                  # avg_stai_mid ~ mod_cng_hum*cong_x_hp + mod_incg_hum*incong_x_hp
                  
                  # Simple Slopes for Humor Relationship to Anxiety
                  hum_cong_slp :=  (hum_mid + mod_cng_hum)
                  hum_avg_slp :=  (hum_mid)
                  hum_incong_slp := (hum_mid + mod_incng_hum)
                  '

# Bootstrap!
# Must use WLS if we do have ordered vars.
slapstick_fit <- lavaan::sem( slapstick_def, 
                              data = clean_cent_dat, 
                              se = "bootstrap",
                              estimator = "ML", 
                              bootstrap = 10000, 
                              parallel ="snow", 
                              ncpus = use_cores
                            )


# Decent text output of model fit and coefficients
summary( slapstick_fit, 
         fit.measures=TRUE, 
         standardized=TRUE, 
         rsquare=TRUE
       )


# Scrollable table in HTML output
standardizedSolution(slapstick_fit, type = "std.all")

# Additional modelfit output with CIs that's a bit more user friendly to text editors
parameterEstimates(slapstick_fit, standardized = TRUE, boot.ci.type = "perc", level=0.95)


```

### Glitter Bomb - Regression

Drop the neutrals.
Since we couldn't get convergence with both congruence and incongruence subsets referenced against no-preference humor    
types (N=12), we're looking for congruence as referenced to incongruence (i.e. are those who experience congruent videos) 
Likely to see a bigger change in anxeity than those who experience incongruent videos?

```{r glitterbomb_model}

# See if dropping the neutrals (no preference), and evaluating congruence as ref'd from incongruence fixes the  
#  multicollinearity issues
#
# NOTE: The commented code looked at if congruence moderated the relationship directly between before and mid anxiety
#       Spolier alert, it did not. So we're left with congruence being no more significant than incongruence, and 
#       a very small, and questionable significance of humor preference and congruence influencing anxiety change above 
#       or beyond those with no humor preference (slapstick results)
glitterbomb_regr <- linReg( clean_cent_dat_red,
                          dep = 'avg_stai_mid',
                          covs = c( 'avg_stai_before', 'humor_pref_cont',
                                    'cong_dc', 'incong_dc',
                                    'cong_x_anx', 'incong_x_anx',
                                    'cong_x_hp', 'incong_x_hp'
                                   ),
                          blocks = list(
                                         list( 'avg_stai_before' ),
                                         list( 'humor_pref_cont'),
                                         list( 'cong_dc', 'cong_x_hp')
                                         # list( 'cong_dc', 'cong_x_anx')
                                       ),
                          modelTest = TRUE,
                          stdEst = TRUE,
                          r2Adj = TRUE,
                          collin = TRUE,
                          ci = TRUE
                        )



glitterbomb_regr


# # Using CENTERED vars - Might be worth bootstrapping glitterbomb eventually, but not done yet.
# slapstick_def <- '
#                   ### F**** This model fails too... this categorical moderation doesnt seem to be working ***
#                   # Primary regression path names followed by * are path names
#                   # avg_stai_mid ~ bef_mid*avg_stai_before + 
#                   #                hum_mid*humor_pref_cont +
#                   #                cong_mid*cong_dc + incong_mid*incong_dc +
#                   #                mod_cng_hum*cong_x_hp + mod_incng_hum*incong_x_hp
#                   
#                   # Covariances: NONE for NOW
#                   avg_stai_before ~~ humor_pref_cont
#                   
#                   # Control Vars ONLY - No Other Predictors
#                   # avg_stai_mid ~  bef_mid*avg_stai_before
#                   
#                   # Main Effects Only - Humor Only, no Cats
#                   # avg_stai_mid ~ bef_mid*avg_stai_before + hum_mid*humor_pref_cont
#                   
#                   # Main Effects Only - Humor w/ Cats 
#                   # avg_stai_mid ~ bef_mid*avg_stai_before + hum_mid*humor_pref_cont + cong_mid*cong_dc + incong_mid*incong_dc
#                   
#                   # Main Effects + Moderation Only - Humor w/ Moderation, no Cats
#                   avg_stai_mid ~ bef_mid*avg_stai_before + hum_mid*humor_pref_cont + mod_cng_hum*cong_x_hp + mod_incng_hum*incong_x_hp
#                   
#                   # Moderated Effects Only - No Main Effects
#                   # avg_stai_mid ~ mod_cng_hum*cong_x_hp + mod_incg_hum*incong_x_hp
#                   
#                   # Simple Slopes for Humor Relationship to Anxiety
#                   hum_cong_slp :=  (hum_mid + mod_cng_hum)
#                   hum_avg_slp :=  (hum_mid)
#                   hum_incong_slp := (hum_mid + mod_incng_hum)
#                   '
# 
# # Bootstrap!
# # Must use WLS if we do have ordered vars.
# slapstick_fit <- lavaan::sem( slapstick_def, 
#                               data = clean_cent_dat, 
#                               se = "bootstrap",
#                               estimator = "ML", 
#                               bootstrap = 10000, 
#                               parallel ="snow", 
#                               ncpus = use_cores
#                             )
# 
# 
# # Decent text output of model fit and coefficients
# summary( slapstick_fit, 
#          fit.measures=TRUE, 
#          standardized=TRUE, 
#          rsquare=TRUE
#        )
# 
# 
# # Scrollable table in HTML output
# standardizedSolution(slapstick_fit, type = "std.all")
# 
# # Additional modelfit output with CIs that's a bit more user friendly to text editors
# parameterEstimates(slapstick_fit, standardized = TRUE, boot.ci.type = "perc", level=0.95)



```

