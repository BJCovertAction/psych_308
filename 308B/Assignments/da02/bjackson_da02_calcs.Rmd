---
title: "PSYCH308B - Data Analysis 02 (DA02)"
author: "Brady C. Jackson"
date: "2024/11/01"

# Write document output to HTML, Word, and PDF output types with a Table of
# contents included.
output: 
  html_document:
    toc: true
  word_document:
    toc: true
  pdf_document:
    toc: true
    latex_engine: xelatex

# This option here enables output to both HTML and PDF formats
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding,
  output_format = "all") })
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

---

```{r package_loading, message=FALSE, warning=FALSE}

# Load packages. Set messages and warnings to FALSE so I don't have to see the
# masking messages in the output.
library(jmv)       # for descriptive
library(ggplot2)
library(dplyr)
library(car)       # for leveneTest
# library(stringr)   # for sub_str operations
# library(psych)
library(Hmisc)     # for fun.dat substitution
# library(see)       # for outliers analysis 
# library(magrittr)
# library(AER)
```

## Investigation of Raw, Unprocessed Data

### Data Loading

First we need to load the data. We check if it's in memory already and delete   
it if it is just to ensure we're working with a clean slate.

```{r data_prep}
# Check if dats_helping exists and, if it does, nuke it first
if( exists("dats_helping") ){
    rm(dats_helping)
}


# First we load the data raw.
dats_helping <- read.csv("./308B.Data.DA2.csv")

# We convert all headings to lower to minimize column naming confusion.
colnames(dats_helping) <- tolower(colnames(dats_helping))

# We cast the values in haste (1,2, or 3) to a factor to prevent them from being
# operated on as if they were integers. I'm going to maintain this column for
# the record of data, but will create an additional array with the categories
# labeled as more descriptive strings appropriately. We use the non-factor 
# haste array as the basis for the character arrays as we can't substitute 
# chars into an array of factors once it is cast as such
dats_helping$haste_names <- dats_helping$haste
dats_helping$haste_disp_names <- dats_helping$haste

# Perform the string substitutions here, first for the raw lower case names
# second for the appropriately cased display names
dats_helping$haste_names[dats_helping$haste_names == 1] <- "early"
dats_helping$haste_names[dats_helping$haste_names == 2] <- "on_time"
dats_helping$haste_names[dats_helping$haste_names == 3] <- "late"

dats_helping$haste_disp_names[dats_helping$haste_disp_names == 1] <- "Early"
dats_helping$haste_disp_names[dats_helping$haste_disp_names == 2] <- "On-Time"
dats_helping$haste_disp_names[dats_helping$haste_disp_names == 3] <- "Late"

# Convert all "group" categories to factors
dats_helping$haste_names <- as.factor(dats_helping$haste_names)
dats_helping$haste_disp_names <- as.factor(dats_helping$haste_disp_names)
dats_helping$haste <- as.factor(dats_helping$haste)

```

### Raw Data Descriptive Stats and Visualization

Code in this section produces basic figures for getting to know our data.  
These are all conducted on data with no outliers removed, processed, or otherwise  
handled.

```{r raw_descriptives_and_visuals}

# Base visuals and Q-Q Normal plot by category.
# Code here checks for data integrity, normality, and homoscedasticity
# NOTE: Given R's propensity for plotting everything in alphabetical order, I ran this twice, once sorted by "haste_names"
#       and another sorted by "haste." I confirmed, visually, that the data were correctly binned in both situations 
#         e.g. the "tetris shapes" in the histogram for "3" were the same as those in "late" etc. But, true to form,
#         R prints the "late" data as the second plot when splitting by "haste_names" and as the third plot when 
#         splitting by "haste number." So, the data labels are all correct, but the print / output order is just 
#         different.
helping_descr_raw = jmv::descriptives( dats_helping, 
                                       vars = "helping", 
                                       splitBy="haste_names", 
                                       hist = TRUE,
                                       dens = TRUE,
                                       qq = TRUE,
                                       sd = TRUE, 
                                       variance = TRUE,
                                       se = TRUE, 
                                       skew = TRUE, 
                                       kurt = TRUE,
                                       missing = TRUE)
print(helping_descr_raw)

# We'll also check the descriptives for the integrated dataset (e.g. not split by group)
helping_descr_int_raw = jmv::descriptives( dats_helping, 
                                           vars = "helping",
                                           hist = TRUE,
                                           dens = TRUE,
                                           qq = TRUE,
                                           sd = TRUE, 
                                           variance = TRUE,
                                           se = TRUE, 
                                           skew = TRUE, 
                                           kurt = TRUE,
                                           missing = TRUE)
print(helping_descr_int_raw)


# Continuity plot: We create a figure of the values of likelihood of helping  
#                  sorted in ascending order just to see how much of the 0-6   
#                  outcome range our observed data span.
# First we an index array to use as our x-values in our ordered plot. Since
# the rows of the dataframe aren't named we can just cast them as ints and
# they'll suffice. Save sort and unsort indices in case we need them later
dats_helping$dats_idx = as.integer(rownames(dats_helping))
dats_helping$sorted_helping = sort(dats_helping$helping, decreasing = FALSE) # sorts ascending
dats_helping$sorted_ids = order(dats_helping$helping, decreasing = FALSE)    # helping[sorted_ids] -> sorted_helping
dats_helping$unsorted_ids = order(dats_helping$sorted_ids)                   # sorted_helping[unsorted_ids] -> helping


# Define the figure scatterplot
cont_plot = ggplot(dats_helping, aes(x = dats_idx, y = sorted_helping) ) + 
                 geom_point( aes(color = "Helping Score") ) + 
                 geom_line( aes(color = "Helping Score")  ) + 
                 labs(x = "Index (unitless)", y = "Likelihood of Helping (0-6)") + 
                 ggtitle("Helping Scores sorted in Ascending Order for Continuity Check") + 
                 geom_hline( aes( yintercept = 0, color = "Upper Limit" ), linetype = "dashed" ) + 
                 geom_hline( aes( yintercept = 6, color = "Lower Limit" ), linetype = "dashed" ) + 
                 scale_color_manual(
                                     name = "Legend",
                                     values = c( "steelblue3", "red4", "red4"),
                                     labels = c("Helping Score", "Upper Limit", "Lower Limit")
                                    ) +
                 theme(legend.position = "right")
cont_plot
                


# Bar chart: We'll check the mean likelihood to help by category with 
#            confidence intervals included.
ggplot(dats_helping, aes( haste_disp_names, helping) ) +
    stat_summary(fun = mean, geom = "bar", position = "dodge", fill="steelblue3") + 
    stat_summary( fun.data = mean_cl_normal, geom = "errorbar", 
                  position = position_dodge(width = 0.90), width = 0.5
                 ) + 
    labs( y = "Mean Likelihood of Helping (0 - 6)",
          x = "Hastiness State") +
    ggtitle('Impact of Haste State on Likelihood to Help') + 
    theme_minimal()


# Category-wise Scatter Plot 
cat_plot = ggplot(dats_helping, aes(x = haste_disp_names, y = helping) ) + 
                  geom_point( aes(color = "Helping Score") ) + 
                  labs(x = "Hastiness State", y = "Likelihood of Helping (0-6)") + 
                  ggtitle("Helping Scores Scatterplot binned by Hastiness State") + 
                  geom_hline( aes( yintercept = 0, color = "Upper Limit" ), linetype = "dashed" ) + 
                  geom_hline( aes( yintercept = 6, color = "Lower Limit" ), linetype = "dashed" ) + 
                  scale_color_manual(
                                     name = "Legend",
                                     values = c( "steelblue3", "red4", "red4"),
                                     labels = c("Helping Score", "Upper Limit", "Lower Limit")
                                    ) +
                 theme(legend.position = "right")
cat_plot


```

### Formalize Model

Model formalization for unprocessed data goes here.

```{r raw_model_definition}
# A simple linear model defined such that helping is dependent upon haste_names
raw_helping_model <- lm(helping~haste_names, data = dats_helping)

```

### Advanced Raw Visuals

More advanced visuals which can be based on model object go here.

```{r advanced_raw_visuals}

# Need to identify the potential residual in the "Late" data (see qq plots) and decide what to do with it.

```

### Test of Variance for Raw Data

[OPTIONAL] The following section checks the homogeneity of variance in all of   
the raw data. This may or may not be necessary depending on what kinds of models  
you're building.

```{r levenes_raw}

# The general data skew and kurtosis measures are reasonably normal. But  
# let's check variance directly:
leveneTest(helping ~ haste_names, dats_helping)

```

### Test / Analysis of Raw Results

Run the test / analysis you intend to conduct on the raw data (no outlier)  
manipulation for the record.

```{r, raw_t_test}

```

### Check Outliers Directly

[OPTIONAL] Can use check_outliers function here as necessary


```{r outlier_analysis}


```

### Decision to Handle Outliers

Use this section to drop or modify outliers.

```{r outlier_handling}


```

## Investigation of Processed Data

Replicate analysis post-outlier handling.

### Processed Data Descriptive Stats and Visualization

```{r processed_descriptives_and_visuals}

```

### Formalize Model of Processed Data

Formalizing the processed model.

```{r processed_model_definition}


```

### Advanced Processed Visuals

Processed data and model visualizations

```{r advanced_processed_visuals}


```

### Test of Variance for Processed Data

[OPTIONAL] Hederoscedasticity check for processed data.

```{r levenes_processed}

```

### Check Test / Analysis Results on Processed Data

Run the Test / Analysis on processed data

```{r, processed_t_test}


```

### Plot Residuals of Processed Data

Residuals plots of processed data.

```{r outlier_analysis_processed}

```

