---
title: "PSYCH308B - Data Analysis 1 (DA1)"
author: "Brady C. Jackson"
date: "2024/10/27"

# Write document output to HTML, Word, and PDF output types with a Table of
# contents included.
output: 
  html_document:
    toc: true
  word_document:
    toc: true
  pdf_document:
    toc: true
    latex_engine: xelatex

# This option here enables output to both HTML and PDF formats
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding,
  output_format = "all") })
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

---

```{r package_loading, message=FALSE, warning=FALSE}

# Load packages. Set messages and warnings to FALSE so I don't have to see the
# masking messages in the output.
library(psych)
library(jmv)       # for descriptive
library(ggplot2)
library(dplyr)
library(Hmisc)     # for fun.dat substitution
library(see)       # for outliers analysis 
library(car)       # for leveneTest
# library(magrittr)
# library(stringr)   # for sub_str
# library(AER)
```

## Investigation of Raw, Unprocessed Data

### Data Loading

First we need to load the data. This is data about growth after traumatic   
stress and the severity of the traumatizing injuries. So we wil name our  
dat variable growth_dats.

```{r data_prep}
# Load the data raw from a CSV. 
growth_dats = read.csv("./308B DA1 Data.csv")

# Our data has one categorical variable, severity, which takes the value of
# either 1 or 0. So we case that column as a factor. Then we cast al column names
# to lower case for readability
growth_dats$SEVERITY <- as.factor(growth_dats$SEVERITY)
colnames(growth_dats) <- tolower(colnames(growth_dats))
```

### Raw Data Descriptive Stats and Visualization
```{r raw_descriptives_and_visuals}

# We'll use the descriptives function from jmv to get a read on the quality 
# of our raw data (completely unprocessed at this point). We include
# a density function fitted to the histogram to help us 
# visualize the distribution shape. We ask for an assessment of missing data
# and we request our sd and variance
growth_descr_raw = jmv::descriptives( growth_dats, 
                                      vars = c("total.srgs"), 
                                      splitBy="severity", 
                                      hist = TRUE,
                                      dens = TRUE,
                                      qq = TRUE,
                                      sd = TRUE, 
                                      variance = TRUE,
                                      se = TRUE, 
                                      skew = TRUE, 
                                      kurt = TRUE,
                                      missing = TRUE)
print(growth_descr_raw)

```

### Formalize Model

We're going to create a series of objects that formalize our linear model 
based off of raw data (no handling of missing data or outliers). This will  
allow for further use of visuals to inspect the raw data.

```{r raw_model_definition}
# We're going to define a linear model based on the stress related growth scores
# as a function of severity of injury
raw_stress_growth_model <- lm(total.srgs~severity, data = growth_dats)
```

### Advanced Raw Visuals

Now that we have a formal model definition, we'll include the more advance   
visuals for inspecting the raw data: bar chart, qq-plot (as generated by ggplot),   
and residuals distribution

```{r advanced_raw_visuals}

# We'll define a bar chart with error bars so we can confirm how "spread out" 
# the groupings are in the data we have (reaffirm conclusions from descriptive
# object)
ggplot(growth_dats, aes( severity, total.srgs) ) +
    stat_summary(fun = mean, geom = "bar", position = "dodge", fill="magenta4") + 
    stat_summary( fun.data = mean_cl_normal, geom = "errorbar", 
                  position = position_dodge(width = 0.90), width = 0.2
                 ) + 
    labs( y = "Mean Stress Related Growth (0 - 100)", 
          x = "0: Moderate Injury   1: Severe Injury"
         ) +
    ggtitle('Effect of Injury Severity on Stress Related Growth')
    theme_minimal() + 
    theme( axis.text.x = element_text(angle = 45, hjust = 1) )

# We'll produce a qq plot independent of the descriptives package just to get 
# some practice in (and see if it's different)
ggplot( raw_stress_growth_model, aes( qqnorm(.stdresid)[[1]], .stdresid) ) +
    geom_point(na.rm = TRUE) + 
    xlab("Theoretical Quantiles") + 
    ylab("Standardized Residuals") + 
    ggtitle("Normal Q-Q")

# Finally we'll get a rough check on homoscedacity by plotting the residuals 
# distribution
raw_resids_all = residuals(raw_stress_growth_model)
hist(raw_resids_all, main="Histogram of Residuals - All Data Collected")

# Capturing all residuals grouped together, regardless of severity level, kind 
# of sucks. So we'll save the residuals output in our dataframe but then create 
# histograms for the filtered results as well (for 0 and for 1)
growth_dats$raw_residuals_all <-raw_resids_all
raw_resids_mod <- growth_dats$raw_residuals_all[growth_dats$severity == 0]
raw_resids_sev <- growth_dats$raw_residuals_all[growth_dats$severity == 1]

# Now create two additional histograms, one for moderate, and one for severe
# using the filtered residuals
hist( raw_resids_mod, 
      main="Histogram of Residuals - All Moderate Injuries",
      col = "yellow2",
      xlab = "Unstandardized Residuals"
      
     )
hist( raw_resids_sev, 
      main="Histogram of Residuals - All Severe Injuries",
      col = "red3",
      xlab = "Unstandardized Residuals"
     )

```

### Test of Variance for Raw Data

The following section checks the homogeneity of variance in all of the raw  
data collected. Outliers and missing values are not modified or changed at all   
yet.  

```{r levenes_raw}
# The general data skew and kurtosis meeasures are reasonably normal. But  
# let's check variance directly:
leveneTest(total.srgs ~ severity, growth_dats)
```

### Check T-Test Results on Raw Data

Even though we can see homogeneity of variance is violated, we're going to check   
The T-test results regardless with all data included just to understand what  
the test looks like.

```{r, raw_t_test}
# This is an independent samples T-test since we have two groups that are not
# matched in pairs
ttestIS(data = growth_dats, 
        vars = "total.srgs", 
        group = "severity", 
        eqv = TRUE, 
        effectSize = TRUE, 
        ci = TRUE, 
        desc = TRUE, 
        welchs = TRUE)


```

### Check Outliers Directly

Given that the data does not pass the homogeneity of variance test, we need  
to look a bit more deeply into the outliers. There's one very obvious one  
in the moderate injury dataset where stress related growth was scored as 0.  
This could be a data entry error or a true value, but given that its the only  
0 in a dataset of 88 scores it is a bit fishy. This would imply, I assume, no  
growth whatsoever which, even if it is valid data, could be indicative of   
some deeper clinical condition in that patient (e.g. severe depression
unrelated to the trauma). But we should check if there are more outliers beyond   
just this one.

```{r outlier_analysis}

# We'll create my own flavor of an outliers plot using the check_outliers 
# function in the performance package. I prefer this output to the weird  
# hull output made by plotting the entire check_outliers output structure
outliers_3_sigma <- performance::check_outliers( raw_stress_growth_model,  
                                                method = "zscore",  
                                                threshold = list("zscore" = 3)
                                               )

# In our general data dataframe we'll create a logical array column that's
# FALSE by default and TRUE for all indices that were flagged as outliers. 
# This will allow us to highlight values in a residuals scatter plot marked as  
# TRUE
growth_dats$outliers_3_sigma_logical <- outliers_3_sigma

# Now we're going to create a simple scatter plot of the residuals and highlight  
# any outliers found as bright pink so they stand out. We'll also label them 
# with both their row number (id) and their residuals value so we can spot
# them in the dataframe if need be.
ggplot( growth_dats, aes( x = id, y = raw_residuals_all) ) +
    geom_point( aes(color = outliers_3_sigma_logical) ) + 
    scale_color_manual( values = c("navy", "magenta"), 
                        name = "Outlier Status",
                        labels = c("Within 3*SD", "Outside 3*SD")
                        ) +
    geom_text(
               data = subset(growth_dats, outliers_3_sigma_logical == TRUE),  # Filter to only include outliers
               aes(label = paste("(", id, ",", raw_residuals_all, ")" ) ),                        # Label with the x-value (severity)
               vjust = -1,                                   # Position above the point
               color = "magenta"                             # Label color
              ) +
    
    labs(
          title = "Scatterplot of Residuals with Outliers Highlighted",
          x = "Index (Row No.)",
          y = "Unstandardized Residuals"
         ) +
    theme_minimal() + 
    theme( plot.title = element_text( face = "italic" ) )



```

### Decision to Handle Outliers

Given that the one outlier in the dataset has a z-score greater than 5, which  
implies that the score is more than 5 standard deviations from the mean, I'm  
just going to drop it. The reported stress-related-growth score for this  
outlier was 1, which is by far the lowest score reported, and implies nearly 
zero growth. As this was such an extreme case, it is reasonable to assume it  
was either a data entry error, or, alternatively, it could have been a real  
score reported for an individual who had low-growth for reasons unrelated to  
the traumatic injury. 

```{r outlier_drops}
# Since we have the logical index identifying outliers embedded in our dataframe  
# we can use that column as a filter for all columns. We want to keep 
# data for scores flagged as "false" in the outliers_3_sigma_logical column  
# So we keep everything that is "NOT" an outlier (!FALSE -> TRUE)
growth_dats_processed <- growth_dats[!growth_dats$outliers_3_sigma_logical, ]
```

## Investigation of Processed Data

Since we removed one outlier from our data, we replicate the bulk of the 
visualizations and analyses here.

### Processed Data Descriptive Stats and Visualization

```{r processed_descriptives_and_visuals}

# We'll use the descriptives function from jmv to get a read on the quality 
# of our raw data (completely unprocessed at this point). We include
# a density function fitted to the histogram to help us 
# visualize the distribution shape. We ask for an assessment of missing data
# and we request our sd and variance
growth_descr_proc = jmv::descriptives( growth_dats_processed, 
                                       vars = c("total.srgs"), 
                                       splitBy="severity", 
                                       hist = TRUE,
                                       dens = TRUE,
                                       qq = TRUE,
                                       sd = TRUE, 
                                       variance = TRUE,
                                       se = TRUE, 
                                       skew = TRUE, 
                                       kurt = TRUE,
                                       missing = TRUE)
print(growth_descr_proc)

```

### Formalize Model of Processed Data

We're going to create a series of objects that formalize our linear model 
based off of processed data (outliers removed). This will  
allow for further use of visuals to inspect the processed data.

```{r processed_model_definition}
# We're going to define a linear model based on the stress related growth scores
# as a function of severity of injury
processed_stress_growth_model <- lm(total.srgs~severity, data = growth_dats_processed)
```

### Advanced Processed Visuals

Now that we have a formal model defintion, we'll include the more advanced  
visuals for inspecting the processed data: bar chart, qq-plot 
(as generated by ggplot), and residuals distributions

```{r advanced_processed_visuals}

# We'll define a bar chart with error bars so we can confirm how "spread out" 
# the groupings are in the data we have (reaffirm conclusions from descriptive
# object)
ggplot(growth_dats_processed, aes( severity, total.srgs) ) +
    stat_summary(fun = mean, geom = "bar", position = "dodge", fill="magenta3") + 
    stat_summary( fun.data = mean_cl_normal, geom = "errorbar", 
                  position = position_dodge(width = 0.90), width = 0.2
                 ) + 
    labs( y = "Mean Stress Related Growth (0 - 100)", 
          x = "0: Moderate Injury   1: Severe Injury"
         ) +
    ggtitle('Effect of Injury Severity on Stress Related Growth')
    theme_minimal() + 
    theme( axis.text.x = element_text(angle = 45, hjust = 1) )

# We'll produce a qq plot independent of the descriptives package just to get 
# some practice in (and see if it's different)
ggplot( processed_stress_growth_model, aes( qqnorm(.stdresid)[[1]], .stdresid) ) +
    geom_point(na.rm = TRUE) + 
    xlab("Theoretical Quantiles") + 
    ylab("Standardized Residuals") + 
    ggtitle("Normal Q-Q")

# Finally we'll get a rough check on homoscedacity by plotting the residuals 
# distribution
processed_resids_all = residuals(processed_stress_growth_model)
hist(processed_resids_all, main="Histogram of Residuals - Outliers Removed")

# Capturing all residuals grouped together, regardless of severity level, kind 
# of sucks. So we'll save the residuals output in our dataframe but then create 
# histograms for the filtered results as well (for 0 and for 1)
growth_dats_processed$processed_residuals_all <- processed_resids_all
processed_resids_mod <- 
    growth_dats_processed$processed_residuals_all[growth_dats_processed$severity == 0]
processed_resids_sev <- 
    growth_dats_processed$processed_residuals_all[growth_dats_processed$severity == 1]

# Now create two additional histograms, one for moderate, and one for severe
# using the filtered residuals
hist( processed_resids_mod, 
      main="Histogram of Residuals - Moderate Injuries - Outliers Removed",
      col = "yellow",
      xlab = "Unstandardized Residuals"
      
     )
hist( raw_resids_sev, 
      main="Histogram of Residuals - Severe Injuries - Outliers Removed",
      col = "red2",
      xlab = "Unstandardized Residuals"
     )

```

### Test of Variance for Processed Data

The following section checks the homogeneity of variance in all of the processed    
data collected. Outliers are removed

```{r levenes_processed}
# The general data skew and kurtosis meeasures are reasonably normal. But  
# let's check variance directly:
leveneTest(total.srgs ~ severity, growth_dats_processed)
```

### Check T-Test Results on Processed Data

Run the T-Test on the processed data

```{r, processed_t_test}
# This is an independent samples T-test since we have two groups that are not
# matched in pairs
ttestIS(data = growth_dats_processed, 
        vars = "total.srgs", 
        group = "severity", 
        eqv = TRUE, 
        effectSize = TRUE, 
        ci = TRUE, 
        desc = TRUE, 
        welchs = TRUE)
```

### Plot Residuals of Processed Data

We'll replicate our residuals plot but since there are no outliers 
in the processed data it should be better sized.

```{r outlier_analysis_processed}

# Create a simple scatter plot of the residuals and highlight  
# any outliers found as bright pink so they stand out. We'll also label them 
# with both their row number (id) and their residuals value so we can spot
# them in the dataframe if need be.
ggplot( growth_dats_processed, aes( x = id, y = raw_residuals_all) ) +
    geom_point( aes(color = outliers_3_sigma_logical) ) + 
    scale_color_manual( values = c("navy", "magenta"), 
                        name = "Outlier Status",
                        labels = c("Within 3*SD", "Outside 3*SD")
                        ) +
    geom_text(
               data = subset(growth_dats_processed, outliers_3_sigma_logical == TRUE),  # Filter to only include outliers
               aes(label = paste("(", id, ",", raw_residuals_all, ")" ) ),                        # Label with the x-value (severity)
               vjust = -1,                                   # Position above the point
               color = "magenta"                             # Label color
              ) +
    
    labs(
          title = "Scatterplot of Residuals with Outliers Removed",
          x = "Index (Row No.)",
          y = "Unstandardized Residuals"
         ) +
    theme_minimal() + 
    theme( plot.title = element_text( face = "italic" ) )

```

